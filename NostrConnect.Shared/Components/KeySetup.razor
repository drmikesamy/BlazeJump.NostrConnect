@using NostrConnect.Shared.Services
@using NostrConnect.Shared.Models
@using BlazeJump.Tools.Helpers
@using BlazeJump.Tools.Enums
@inject IKeyStorageService KeyStorage
@inject INostrService NostrService

<div class="key-setup">
    @if (_hasKey)
    {
        <div class="key-info">
            <h3>Your Nostr Identity</h3>
            <p><strong>Public Key (npub):</strong></p>
            <code>@_npubKey</code>
            <p class="mt-3"><strong>Public Key (hex):</strong></p>
            <code style="font-size: 0.8em;">@_publicKey</code>
            <button class="btn btn-danger mt-3" onclick="@ClearKeys">Clear Keys</button>
        </div>
    }
    else
    {
        <div class="no-key">
            <h3>Welcome to Nostr Connect</h3>
            <p>You don't have a Nostr identity yet. Generate one to get started.</p>
            <button class="btn btn-primary" onclick="@GenerateKeys">Generate Keys</button>
            
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="alert alert-danger mt-3">
                    @_errorMessage
                </div>
            }
        </div>
    }
</div>

@code {
    private bool _hasKey;
    private string _publicKey = string.Empty;
    private string _npubKey = string.Empty;
    private string _errorMessage = string.Empty;

    [Parameter]
    public EventCallback OnKeysChanged { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await CheckForKeys();
    }

    private async Task CheckForKeys()
    {
        _hasKey = await KeyStorage.HasStoredKeyPairAsync();
        if (_hasKey)
        {
            var keyPair = await KeyStorage.GetStoredKeyPairAsync();
            if (keyPair != null)
            {
                _publicKey = keyPair.PublicKey;
                _npubKey = GeneralHelpers.HexToBech32(_publicKey, Bech32PrefixEnum.npub);
            }
        }
    }

    private async Task GenerateKeys()
    {
        try
        {
            _errorMessage = string.Empty;
            var keyPair = await NostrService.GenerateKeyPairAsync();
            await KeyStorage.SaveKeyPairAsync(keyPair);
            await CheckForKeys();
            await OnKeysChanged.InvokeAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error generating keys: {ex.Message}";
        }
    }

    private async Task ClearKeys()
    {
        await KeyStorage.ClearKeyPairAsync();
        _hasKey = false;
        _publicKey = string.Empty;
        _npubKey = string.Empty;
        await OnKeysChanged.InvokeAsync();
    }
}
