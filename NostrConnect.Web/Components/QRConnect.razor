@using NostrConnect.Shared.Services
@using NostrConnect.Shared.Models
@using QRCoder
@using System.Drawing
@using BlazeJump.Tools.Services.Connections
@using BlazeJump.Tools.Services.Crypto
@using BlazeJump.Tools.Models
@using BlazeJump.Tools.Enums
@inject INostrService NostrService
@inject INostrConnectService NostrConnectService
@inject IRelayManager RelayManager
@inject ICryptoService CryptoService

<div class="qr-connect">
    @if (_session == null)
    {
        <button class="btn btn-primary" @onclick="CreateSession">Create Connection QR Code</button>
    }
    else if (!_session.IsConnected)
    {
        <div class="qr-display">
            <h3>Scan with your Nostr Connect app</h3>
            @if (!string.IsNullOrEmpty(_qrCodeDataUrl))
            {
                <img src="@_qrCodeDataUrl" alt="QR Code" style="max-width: 400px;" />
            }
            <div class="mt-3" style="background: #f0f0f0; padding: 15px; border-radius: 5px; max-width: 600px;">
                <h5>Connection Status:</h5>
                @foreach (var status in _statusUpdates)
                {
                    <div style="margin: 5px 0; padding: 5px; background: white; border-left: 3px solid @(status.Contains("✓") ? "green" : status.Contains("✗") ? "red" : "#007bff"); font-family: monospace; font-size: 11px;">
                        @status
                    </div>
                }
            </div>
            <details class="mt-3">
                <summary style="cursor: pointer; color: #007bff;">Connection Details</summary>
                <div style="background: #f8f9fa; padding: 10px; margin-top: 10px; font-family: monospace; font-size: 11px;">
                    <p><strong>Ephemeral Key:</strong> @_ephemeralKeyPair?.PublicKey</p>
                    <p><strong>Relay:</strong> wss://relay.damus.io</p>
                    <p><strong>Session ID:</strong> @_session.SessionId</p>
                </div>
            </details>
        </div>
    }
    else
    {
        <div class="connected">
            <h3>✓ Connected!</h3>
            <p>Your device is now connected.</p>
            <p>Public Key: @_session.AppPubKey</p>
            <button class="btn btn-secondary" @onclick="Disconnect">Disconnect</button>
        </div>
    }
</div>

@code {
    private NostrConnectSession? _session;
    private string _qrCodeDataUrl = string.Empty;
    private NostrKeyPair? _ephemeralKeyPair;
    private bool _isListening = false;
    private List<string> _statusUpdates = new();

    protected virtual async Task OnInitializedAsync(){
        RelayManager.ProcessMessageQueue += ProcessReceivedMessages;
    }

    private async Task CreateSession()
    {
        _statusUpdates.Clear();
        _ephemeralKeyPair = await NostrService.GenerateKeyPairAsync();
        _ephemeralKeyPair.IsEphemeral = true;
        _session = await NostrConnectService.CreateSessionAsync(_ephemeralKeyPair.PublicKey);
        var connectionUrl = $"nostrconnect://{_ephemeralKeyPair.PublicKey}?relay=wss://relay.damus.io&metadata={{\"name\":\"Nostr Connect Web\",\"url\":\"http://localhost\"}}";
        GenerateQRCode(connectionUrl);

        _ = Task.Run(async () => await ListenForConnection());

        StateHasChanged();
    }

    private async Task ListenForConnection()
    {
        if (_ephemeralKeyPair == null || _session == null || _isListening)
            return;

        _isListening = true;

        try
        {
            RelayManager.TryAddUri("wss://relay.damus.io");
            await RelayManager.OpenConnection("wss://relay.damus.io");
            var filter = new Filter
            {
                Kinds = new List<int> { (int)KindEnum.EncryptedDirectMessages },
                TaggedPublicKeys = new List<string> { _ephemeralKeyPair.PublicKey },
                Limit = 100
            };

            var subscriptionId = Guid.NewGuid().ToString();
            await RelayManager.QueryRelays(subscriptionId, MessageTypeEnum.Req, new List<Filter> { filter });

            for (int i = 0; i < 120 && _session != null && !_session.IsConnected; i++)
            {
                await Task.Delay(1000);

                var messageCount = 0;
                while (RelayManager.ReceivedMessages.TryDequeue(out var message))
                {
                    messageCount++;
                    
                    if (message.MessageType == MessageTypeEnum.Event && message.Event != null && message.Event.Kind == KindEnum.EncryptedDirectMessages)
                    {
                        var content = message.Event.Content ?? "";
                        var parts = content.Split("?iv=");
                        if (parts.Length == 2)
                        {
                            var cipherText = parts[0];
                            var iv = parts[1];
                            var appPubKey = message.Event.Pubkey ?? "";
                            
                            var decrypted = await CryptoService.AesDecrypt(cipherText, appPubKey, iv, ethereal: true);

                            if (decrypted.Contains("\"result\":\"ack\""))
                            {
                                _session.IsConnected = true;
                                _session.AppPubKey = appPubKey;
                                await InvokeAsync(StateHasChanged);
                                break;
                            }
                        }
                    }
                }
            }
        }
        catch (Exception)
        {
        }
        finally
        {
            _isListening = false;
        }
    }

    private void GenerateQRCode(string data)
    {
        using var qrGenerator = new QRCodeGenerator();
        using var qrCodeData = qrGenerator.CreateQrCode(data, QRCodeGenerator.ECCLevel.Q);
        using var qrCode = new PngByteQRCode(qrCodeData);
        var qrCodeBytes = qrCode.GetGraphic(20);
        _qrCodeDataUrl = $"data:image/png;base64,{Convert.ToBase64String(qrCodeBytes)}";
    }

    private void Disconnect()
    {
        _session = null;
        _qrCodeDataUrl = string.Empty;
        _ephemeralKeyPair = null;
    }
}
