@inherits LayoutComponentBase
@using BlazeJump.Tools.Models
@using MudBlazor
@using NostrConnect.Maui.Services.Identity
@inject NavigationManager NavigationManager
@inject INativeIdentityService IdentityService

<MudThemeProvider Theme="_theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    @if (IdentityService.ActiveUserProfile != null)
    {
        <!-- App Bar -->
        <MudAppBar Elevation="1">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Default" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
            <MudText Typo="Typo.h6" Color="Color.Default">Desilo</MudText>
            <MudSpacer />
            <MudIconButton Icon="@Icons.Material.Filled.QrCodeScanner" Color="Color.Default" OnClick="@(() => NavigationManager.NavigateTo("sync"))" />
            <MudIconButton Icon="@Icons.Material.Filled.AccountCircle" Color="Color.Primary" Class="ml-2" OnClick="@(() => _isProfileOpen = true)" />
        </MudAppBar>

        <!-- Sidebar Drawer -->
        <MudDrawer @bind-Open="_drawerOpen" Elevation="2">
            <MudDrawerHeader>
                <MudText Typo="Typo.h6">Desilo</MudText>
            </MudDrawerHeader>
            <MudNavMenu>
                <MudNavLink Href="/overview" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>
                <MudNavLink Href="/appointments" Icon="@Icons.Material.Filled.CalendarMonth">Appointments</MudNavLink>
                <MudNavLink Href="/medications" Icon="@Icons.Material.Filled.MedicalServices">Medications</MudNavLink>
                <MudNavLink Href="/vitals" Icon="@Icons.Material.Filled.Insights">Vitals</MudNavLink>
                <MudNavLink Icon="@Icons.Material.Filled.Description">Reports</MudNavLink>
                <MudDivider Class="my-2" />
                <MudNavLink Icon="@Icons.Material.Filled.Logout">Logout Session</MudNavLink>
            </MudNavMenu>
        </MudDrawer>

        <!-- Profile Drawer -->
        <MudDrawer @bind-Open="_isProfileOpen" Anchor="Anchor.Right" Elevation="1" Variant="@DrawerVariant.Temporary" Width="320px">
            <MudDrawerHeader>
                <MudText Typo="Typo.h6" Class="font-bold">Profiles</MudText>
            </MudDrawerHeader>
            <div class="pa-4 d-flex flex-column gap-3">
                <MudText Typo="Typo.caption" Class="fw-bold mb-1" Style="color: #94a3b8; text-transform: uppercase;">Switch Profile</MudText>

                @foreach (var profile in IdentityService.UserProfiles.Values)
                {
                    <MudPaper Outlined="true"
                              Class="@(profile == IdentityService.ActiveUserProfile ? "pa-3 rounded-xl border-2 border-primary mud-theme-primary-light" : "pa-3 rounded-xl border-1")"
                              Style="cursor: pointer;"
                              @onclick="@(() => SwitchProfile(profile))">
                        <div class="d-flex align-center gap-3">
                            <MudAvatar Color="@(profile == IdentityService.ActiveUserProfile ? Color.Primary : Color.Default)" Size="Size.Medium">
                                <MudIcon Icon="@Icons.Material.Filled.Person" />
                            </MudAvatar>
                            <div>
                                <MudText Typo="Typo.body2" Class="font-bold">@profile.Name</MudText>
                            </div>
                        </div>
                    </MudPaper>
                }

                <MudButton Variant="Variant.Outlined" FullWidth="true" Class="rounded-xl border-dashed py-3" StartIcon="@Icons.Material.Filled.Add">
                    Add Sub-Profile
                </MudButton>
            </div>
            <div class="mt-auto pa-4">
                <MudDivider Class="mb-4" />
                <MudButton Variant="Variant.Text" FullWidth="true" StartIcon="@Icons.Material.Filled.Settings" Style="justify-content: start;">Account Settings</MudButton>
                <MudButton Variant="Variant.Text" FullWidth="true" StartIcon="@Icons.Material.Filled.Delete" Color="Color.Error" Style="justify-content: start;">Delete Profile</MudButton>
            </div>
        </MudDrawer>
    }

    <MudMainContent Style="padding-bottom: 80px;">
        <MudContainer MaxWidth="MaxWidth.Large" Class="pa-2">
            @Body
        </MudContainer>
    </MudMainContent>

    @if (IdentityService.ActiveUserProfile != null)
    {
        <!-- Bottom Navigation Bar -->
        <MudAppBar Bottom="true" Fixed="true" Elevation="8">
            <MudToggleGroup T="string"
                            Value="@GetActiveRoute()"
                            ValueChanged="@((val) => NavigateAndClose(val))"
                            SelectionMode="SelectionMode.SingleSelection">
                <MudToggleItem Value="@("vitals")">
                    <MudStack Spacing="0" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.MonitorHeart" />
                        <MudText Typo="Typo.caption">Vitals</MudText>
                    </MudStack>
                </MudToggleItem>

                <MudToggleItem Value="@("history")">
                    <MudStack Spacing="0" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.Assignment" />
                        <MudText Typo="Typo.caption">History</MudText>
                    </MudStack>
                </MudToggleItem>

                <MudToggleItem Value="@("medications")">
                    <MudStack Spacing="0" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.Medication" />
                        <MudText Typo="Typo.caption">Meds</MudText>
                    </MudStack>
                </MudToggleItem>

                <MudToggleItem Value="@("allergies")">
                    <MudStack Spacing="0" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.Healing" />
                        <MudText Typo="Typo.caption">Allergies</MudText>
                    </MudStack>
                </MudToggleItem>

                <MudToggleItem Value="@("vaccinations")">
                    <MudStack Spacing="0" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.Vaccines" />
                        <MudText Typo="Typo.caption">Vaccines</MudText>
                    </MudStack>
                </MudToggleItem>

                <MudToggleItem Value="@("appointments")">
                    <MudStack Spacing="0" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" />
                        <MudText Typo="Typo.caption">Calendar</MudText>
                    </MudStack>
                </MudToggleItem>
            </MudToggleGroup>
        </MudAppBar>
    }
</MudLayout>

    @code {
    [CascadingParameter]
    private RouteData? RouteData { get; set; }
    private bool _isProfileOpen = false;
    bool _drawerOpen = false;

    private MudTheme _theme = new MudTheme()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = "#2563eb",
            Secondary = "#7c3aed",
            AppbarBackground = "rgba(255, 255, 255, 0.8)",
            Background = "#f8fafc",
            Success = "#10b981",
            Error = "#f43f5e"
        },
        LayoutProperties = new LayoutProperties()
        {
            DefaultBorderRadius = "16px"
        }
    };

    private string GetActiveRoute()
    {
        var routeAttribute = RouteData?.PageType
                            .GetCustomAttributes(typeof(RouteAttribute), inherit: true)
                            .FirstOrDefault() as RouteAttribute;

        return routeAttribute?.Template ?? "/";
    }

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    private void SwitchProfile(UserProfile p)
    {
        IdentityService.ActiveUserProfile = p;
        _isProfileOpen = false;
    }

    private void NavigateAndClose(string path)
    {
        _drawerOpen = false;
        _isProfileOpen = false;
        NavigationManager.NavigateTo(path);
    }
}