@page "/vitals"
@using NostrConnect.Maui.Services.Fhir
@using NostrConnect.Maui.Services.Fhir.Extensions
@using NostrConnect.Maui.Services.Identity
@using Hl7.Fhir.Model
@using Task = System.Threading.Tasks.Task
@inject IFhirResourceService<Observation> FhirService
@inject INativeIdentityService IdentityService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Small" Class="pa-4">
    <div class="d-flex justify-space-between align-center mb-6">
        <MudText Typo="Typo.h5" Class="font-bold">Vital Signs</MudText>
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick="@(() => _addDialogOpen = true)">
            Add Vital
        </MudButton>
    </div>

    @if (_vitals.Any())
    {
        <MudStack Spacing="3">
            @foreach (var (vital, localId) in _vitals)
            {
                <MudPaper Outlined="true" Class="pa-4 rounded-xl">
                    <div class="d-flex justify-space-between align-center">
                        <div>
                            <MudText Typo="Typo.body1" Class="font-bold">@vital.GetType()</MudText>
                            <MudText Typo="Typo.h5" Class="font-bold">@vital.GetValue() @vital.GetUnit()</MudText>
                            <MudText Typo="Typo.body2" Style="color: #64748b;">@vital.GetTimestamp().ToString("MMM dd, yyyy HH:mm")</MudText>
                        </div>
                        <MudIcon Icon="@vital.GetVitalIcon()" Color="Color.Error" Size="Size.Large" />
                    </div>
                </MudPaper>
            }
        </MudStack>
    }
    else
    {
        <MudAlert Severity="Severity.Info">
            No vital signs recorded yet. Click "Add Vital" to record your first measurement.
        </MudAlert>
    }
</MudContainer>

<MudDialog @bind-Visible="_addDialogOpen">
    <TitleContent>
        <MudText Typo="Typo.h6">Add Vital Sign</MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <MudSelect @bind-Value="_type" Label="Type" Variant="Variant.Outlined" Required>
                <MudSelectItem Value="@("Heart Rate")">Heart Rate</MudSelectItem>
                <MudSelectItem Value="@("Blood Pressure")">Blood Pressure</MudSelectItem>
                <MudSelectItem Value="@("Temperature")">Temperature</MudSelectItem>
                <MudSelectItem Value="@("Weight")">Weight</MudSelectItem>
                <MudSelectItem Value="@("Blood Glucose")">Blood Glucose</MudSelectItem>
                <MudSelectItem Value="@("Oxygen Saturation")">Oxygen Saturation</MudSelectItem>
            </MudSelect>
            <MudNumericField @bind-Value="_value" Label="Value" Variant="Variant.Outlined" Required />
            <MudTextField @bind-Value="_unit" Label="Unit" Variant="Variant.Outlined" Required 
                          Placeholder="e.g., bpm, mmHg, °F, lbs, mg/dL, %" />
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _addDialogOpen = false)">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SaveVital">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<(Observation, Guid)> _vitals = new();
    private bool _addDialogOpen = false;
    
    // Form fields
    private string _type = string.Empty;
    private decimal _value = 0;
    private string _unit = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadVitals();
    }

    private async Task LoadVitals()
    {
        var publicKey = IdentityService.ActiveUserProfile?.PublicKey;
        if (string.IsNullOrEmpty(publicKey))
            return;

        var observations = await FhirService.GetAllAsync(publicKey);
        _vitals = observations.Select(o => (o, FhirService.GetLocalResourceId(o) ?? Guid.Empty)).ToList();
    }

    private async Task SaveVital()
    {
        if (string.IsNullOrWhiteSpace(_type) || 
            _value <= 0 || 
            string.IsNullOrWhiteSpace(_unit))
        {
            Snackbar.Add("Please fill in all fields", Severity.Warning);
            return;
        }

        try
        {
            var patientId = IdentityService.ActiveUserProfile?.PublicKey;
            var observation = ObservationExtensions.CreateVitalSign(_type, _value, _unit, patientId);

            await FhirService.SaveAsync(observation);
            Snackbar.Add("Vital sign saved and posted to Nostr with FHIR format", Severity.Success);
            
            _addDialogOpen = false;
            _type = string.Empty;
            _value = 0;
            _unit = string.Empty;
            
            await LoadVitals();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving vital sign: {ex.Message}", Severity.Error);
        }
    }
}
