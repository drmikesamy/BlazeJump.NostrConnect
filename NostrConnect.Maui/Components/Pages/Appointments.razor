@page "/appointments"
@using NostrConnect.Maui.Services
@using NostrConnect.Maui.Services.Identity
@using NostrConnect.Maui.Models
@inject IHealthDataService HealthDataService
@inject INativeIdentityService IdentityService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Small" Class="pa-4">
    <div class="d-flex justify-space-between align-center mb-6">
        <MudText Typo="Typo.h5" Class="font-bold">Appointments</MudText>
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick="@(() => _addDialogOpen = true)">
            Add Appointment
        </MudButton>
    </div>

    @if (_appointments.Any())
    {
        <MudTabs Elevation="0" Rounded="true" Class="mb-4">
            <MudTabPanel Text="Upcoming">
                <MudStack Spacing="3" Class="mt-4">
                    @foreach (var appointment in _appointments.Where(a => a.DateTime >= DateTime.Now).OrderBy(a => a.DateTime))
                    {
                        <MudPaper Outlined="true" Class="pa-4 rounded-xl">
                            <div class="d-flex align-center gap-4">
                                <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Class="rounded-lg">
                                    <MudIcon Icon="@Icons.Material.Filled.Event" />
                                </MudAvatar>
                                <div class="flex-grow-1">
                                    <MudText Typo="Typo.body1" Class="font-bold">@appointment.Title</MudText>
                                    <MudText Typo="Typo.body2" Style="color: #64748b;">@appointment.Provider</MudText>
                                    <MudText Typo="Typo.body2" Style="color: #64748b;">
                                        @appointment.DateTime.ToString("MMM dd, yyyy 'at' HH:mm")
                                    </MudText>
                                    @if (!string.IsNullOrWhiteSpace(appointment.Location))
                                    {
                                        <MudText Typo="Typo.caption" Style="color: #94a3b8;">
                                            <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" /> @appointment.Location
                                        </MudText>
                                    }
                                </div>
                            </div>
                            @if (!string.IsNullOrWhiteSpace(appointment.Notes))
                            {
                                <MudDivider Class="my-3" />
                                <MudText Typo="Typo.body2" Style="color: #64748b;">@appointment.Notes</MudText>
                            }
                        </MudPaper>
                    }
                </MudStack>
            </MudTabPanel>
            <MudTabPanel Text="Past">
                <MudStack Spacing="3" Class="mt-4">
                    @foreach (var appointment in _appointments.Where(a => a.DateTime < DateTime.Now).OrderByDescending(a => a.DateTime))
                    {
                        <MudPaper Outlined="true" Class="pa-4 rounded-xl" Style="opacity: 0.7;">
                            <div class="d-flex align-center gap-4">
                                <MudAvatar Color="Color.Default" Variant="Variant.Outlined" Class="rounded-lg">
                                    <MudIcon Icon="@Icons.Material.Filled.Event" />
                                </MudAvatar>
                                <div class="flex-grow-1">
                                    <MudText Typo="Typo.body1" Class="font-bold">@appointment.Title</MudText>
                                    <MudText Typo="Typo.body2" Style="color: #64748b;">@appointment.Provider</MudText>
                                    <MudText Typo="Typo.body2" Style="color: #64748b;">
                                        @appointment.DateTime.ToString("MMM dd, yyyy")
                                    </MudText>
                                </div>
                            </div>
                        </MudPaper>
                    }
                </MudStack>
            </MudTabPanel>
        </MudTabs>
    }
    else
    {
        <MudAlert Severity="Severity.Info">
            No appointments recorded yet. Click "Add Appointment" to schedule your first one.
        </MudAlert>
    }
</MudContainer>

<MudDialog @bind-Visible="_addDialogOpen">
    <TitleContent>
        <MudText Typo="Typo.h6">Add Appointment</MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <MudTextField @bind-Value="_newAppointment.Title" Label="Title" Variant="Variant.Outlined" Required 
                          Placeholder="e.g., Annual Checkup" />
            <MudTextField @bind-Value="_newAppointment.Provider" Label="Provider" Variant="Variant.Outlined" Required 
                          Placeholder="e.g., Dr. Smith" />
            <MudDatePicker @bind-Date="_appointmentDate" Label="Date" Variant="Variant.Outlined" Required />
            <MudTimePicker @bind-Time="_appointmentTime" Label="Time" Variant="Variant.Outlined" Required />
            <MudTextField @bind-Value="_newAppointment.Location" Label="Location" Variant="Variant.Outlined" 
                          Placeholder="e.g., Medical Center, Room 301" />
            <MudTextField @bind-Value="_newAppointment.Notes" Label="Notes" Variant="Variant.Outlined" Lines="3" 
                          Placeholder="Additional information..." />
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _addDialogOpen = false)">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SaveAppointment">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<Appointment> _appointments = new();
    private Appointment _newAppointment = new();
    private bool _addDialogOpen = false;
    private DateTime? _appointmentDate;
    private TimeSpan? _appointmentTime;

    protected override async Task OnInitializedAsync()
    {
        await LoadAppointments();
    }

    private async Task LoadAppointments()
    {
        var publicKey = IdentityService.ActiveUserProfile?.PublicKey;
        if (string.IsNullOrEmpty(publicKey))
            return;

        _appointments = await HealthDataService.GetAppointmentsAsync(publicKey);
    }

    private async Task SaveAppointment()
    {
        if (string.IsNullOrWhiteSpace(_newAppointment.Title) || 
            string.IsNullOrWhiteSpace(_newAppointment.Provider) ||
            !_appointmentDate.HasValue ||
            !_appointmentTime.HasValue)
        {
            Snackbar.Add("Please fill in all required fields", Severity.Warning);
            return;
        }

        _newAppointment.DateTime = _appointmentDate.Value.Date + _appointmentTime.Value;

        await HealthDataService.SaveAppointmentAsync(_newAppointment);
        Snackbar.Add("Appointment saved and posted to Nostr", Severity.Success);
        
        _addDialogOpen = false;
        _newAppointment = new();
        _appointmentDate = null;
        _appointmentTime = null;
        await LoadAppointments();
    }
}
