@page "/medications"
@using NostrConnect.Maui.Services.Fhir
@using NostrConnect.Maui.Services.Fhir.Extensions
@using NostrConnect.Maui.Services.Identity
@using Hl7.Fhir.Model
@using Task = System.Threading.Tasks.Task
@inject IFhirResourceService<Medication> FhirService
@inject INativeIdentityService IdentityService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="py-2">
    <div class="d-flex justify-space-between align-center mb-3">
        <MudText Typo="Typo.h4" Class="font-bold">Medications</MudText>
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick="@(() => _addDialogOpen = true)">
            Add
        </MudButton>
    </div>

    @if (_medications.Any())
    {
        <MudTabs Elevation="2" Rounded="true">
            <MudTabPanel Text="Active">
                <MudStack Spacing="3" Class="mt-4">
                    @foreach (var (medication, localId) in _medications.Where(m => m.Item1.IsActive()))
                    {
                        <MudPaper Outlined="true" Class="pa-3 rounded-xl">
                            <div class="d-flex justify-space-between align-center mb-2">
                                <MudText Typo="Typo.body1" Class="font-bold">@medication.GetName()</MudText>
                                <MudChip T="string" Color="Color.Success" Size="Size.Small" Variant="Variant.Filled">ACTIVE</MudChip>
                            </div>
                            <MudText Typo="Typo.body2" Style="color: #64748b;">@medication.GetDosage()</MudText>
                            <MudText Typo="Typo.body2" Style="color: #64748b;">@medication.GetFrequency()</MudText>
                            <MudText Typo="Typo.caption" Style="color: #94a3b8;">Started: @medication.GetStartDate().ToString("MMM dd, yyyy")</MudText>
                        </MudPaper>
                    }
                </MudStack>
            </MudTabPanel>
            <MudTabPanel Text="Inactive">
                <MudStack Spacing="3" Class="mt-4">
                    @foreach (var (medication, localId) in _medications.Where(m => !m.Item1.IsActive()))
                    {
                        <MudPaper Outlined="true" Class="pa-3 rounded-xl" Style="opacity: 0.7;">
                            <div class="d-flex justify-space-between align-center mb-2">
                                <MudText Typo="Typo.body1" Class="font-bold">@medication.GetName()</MudText>
                                <MudChip T="string" Color="Color.Default" Size="Size.Small" Variant="Variant.Outlined">STOPPED</MudChip>
                            </div>
                            <MudText Typo="Typo.body2" Style="color: #64748b;">@medication.GetDosage()</MudText>
                            <MudText Typo="Typo.caption" Style="color: #94a3b8;">
                                @medication.GetStartDate().ToString("MMM dd, yyyy") - @(medication.GetEndDate()?.ToString("MMM dd, yyyy") ?? "Unknown")
                            </MudText>
                        </MudPaper>
                    }
                </MudStack>
            </MudTabPanel>
        </MudTabs>
    }
    else
    {
        <MudAlert Severity="Severity.Info">
            No medications recorded yet. Click "Add Medication" to add your first one.
        </MudAlert>
    }
</MudContainer>

<MudDialog @bind-Visible="_addDialogOpen">
    <TitleContent>
        <MudText Typo="Typo.h6">Add Medication</MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <MudTextField @bind-Value="_name" Label="Medication Name" Variant="Variant.Outlined" Required />
            <MudTextField @bind-Value="_dosage" Label="Dosage" Variant="Variant.Outlined" Required 
                          Placeholder="e.g., 500mg" />
            <MudTextField @bind-Value="_frequency" Label="Frequency" Variant="Variant.Outlined" Required 
                          Placeholder="e.g., Twice daily" />
            <MudDatePicker @bind-Date="_startDate" Label="Start Date" Variant="Variant.Outlined" Required />
            <MudSwitch @bind-Value="_isActive" Label="Currently Taking" Color="Color.Success" />
            @if (!_isActive)
            {
                <MudDatePicker @bind-Date="_endDate" Label="End Date" Variant="Variant.Outlined" />
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _addDialogOpen = false)">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SaveMedication">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<(Medication, Guid)> _medications = new();
    private bool _addDialogOpen = false;
    
    // Form fields
    private string _name = string.Empty;
    private string _dosage = string.Empty;
    private string _frequency = string.Empty;
    private DateTime? _startDate = DateTime.Today;
    private DateTime? _endDate;
    private bool _isActive = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadMedications();
    }

    private async Task LoadMedications()
    {
        var publicKey = IdentityService.ActiveUserProfile?.PublicKey;
        if (string.IsNullOrEmpty(publicKey))
            return;

        var resources = await FhirService.GetAllAsync(publicKey);
        _medications = resources.Select(r => (r, FhirService.GetLocalResourceId(r) ?? Guid.Empty)).ToList();
    }

    private async Task SaveMedication()
    {
        if (string.IsNullOrWhiteSpace(_name) || 
            string.IsNullOrWhiteSpace(_dosage) ||
            string.IsNullOrWhiteSpace(_frequency) ||
            !_startDate.HasValue)
        {
            Snackbar.Add("Please fill in all required fields", Severity.Warning);
            return;
        }

        try
        {
            var medication = MedicationExtensions.CreateNew(
                _name, _dosage, _frequency, _startDate.Value, _isActive);

            if (!_isActive && _endDate.HasValue)
            {
                medication.SetEndDate(_endDate.Value);
            }

            await FhirService.SaveAsync(medication);
            Snackbar.Add("Medication saved and posted to Nostr with FHIR format", Severity.Success);
            
            _addDialogOpen = false;
            _name = string.Empty;
            _dosage = string.Empty;
            _frequency = string.Empty;
            _startDate = DateTime.Today;
            _endDate = null;
            _isActive = true;
            
            await LoadMedications();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving medication: {ex.Message}", Severity.Error);
        }
    }
}
