@page "/"
@using BlazeJump.Tools.Services.Logging
@using NostrConnect.Maui.Services.Identity
@using BlazeJump.Tools.Services.Connections
@using BlazeJump.Tools.Services.Crypto
@using BlazeJump.Tools.Services.Identity
@using BlazeJump.Tools.Models
@using BlazeJump.Tools.Models.NostrConnect
@using BlazeJump.Tools.Builders
@using BlazeJump.Tools.Enums
@using BlazeJump.Tools.Helpers
@using MudBlazor
@inject IRelayManager RelayManager
@inject ICryptoService CryptoService
@inject INativeIdentityService IdentityService
@inject ILoggingService LoggingService
@inject NavigationManager NavigationManager
@implements IDisposable

<PageTitle>NostrConnect - Home</PageTitle>

@if (isLoading)
{
    <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Style="min-height: 400px;">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        <MudText Typo="Typo.body2" Class="mt-4">Loading...</MudText>
    </MudStack>
}
else if (IdentityService.ActiveUserProfile == null)
{
    <MudStack AlignItems="AlignItems.Stretch">
        <MudText Typo="Typo.h4" Class="fw-bold mb-2" Style="color: #0f172a;">Welcome to Desilo</MudText>
        <MudText Typo="Typo.body1" Class="mb-12" Style="color: #64748b; max-width: 300px;">
            Your secure, private gateway to your health records and vitals.
        </MudText>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   Size="Size.Large"
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick="@(() => NavigationManager.NavigateTo("/profile"))">
            Create New Profile
        </MudButton>
        <MudButton Variant="Variant.Outlined"
                   Color="Color.Default"
                   Size="Size.Large"
                   OnClick="@(() => NavigationManager.NavigateTo("/import-key"))">
            Import Private Key
        </MudButton>

        <MudText Typo="Typo.caption" Class="mt-8" Style="color: #94a3b8;">
            Secured by End-to-End Encryption
        </MudText>
    </MudStack>
}

@code {
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        IdentityService.NotifySessionStateChanged += OnSessionStatusChanged;
        LoggingService.LogAdded += OnLogAdded;

        if (!RelayManager.Relays.Contains("wss://relay.damus.io"))
            RelayManager.TryAddUri("wss://relay.damus.io");

        await IdentityService.EnsureInitializedAsync();
        
        if (IdentityService.ActiveUserProfile != null)
        {
            NavigationManager.NavigateTo("/overview");
        }
        else
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async void OnSessionStatusChanged(object? sender, NostrConnectSession session)
    {
        await InvokeAsync(StateHasChanged);
    }

    private void OnLogAdded(object? sender, string log)
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        IdentityService.NotifySessionStateChanged -= OnSessionStatusChanged;
        LoggingService.LogAdded -= OnLogAdded;
    }
}
